<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--キャッシュ無効化-->
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    <!---->
    <title>Gestures.js</title>
    <script src="./GestureDetector.js"></script>
    <script src="../Calender4Students/js/main.js"></script>
    <link rel="stylesheet" href="./style.css" type="text/css" />
</head>
<body>
    <header id="header">
        <div>
            <!--スライドダウンして出すメニュー-->
            <div id="header_menu">
                <div>
                    <h3>SLIDER MENU</h3>
                </div>
            </div>
            <!--タイトル-->
            <div id="title">
                <h1>Gesture Detector JS</h1>
            </div>
        </div>
    </header>
    <main>
    </main>
    <div id="layer" data-default-opacity='0.5'></div>
    <script>
        window.addEventListener("load", () => {
            let header = document.getElementById("header");
            let header_menu = document.querySelector("#header #header_menu");
            let layer = document.getElementById("layer");
            let layer_defaultOpacity = Number(layer.dataset["defaultOpacity"]);

            //ヘッダーから引き出せるメニュー
            let header_menu_initial_marginTop = header.querySelector("#title").clientHeight;
            header_menu.style.marginTop = String(header_menu_initial_marginTop) + "px";

            //一時保存情報
            let tmp = {};

            //メニュー開く
            function header_menu_open(gesEvent){
                layer.style.display = 'block';
                layer.style.opacity = layer_defaultOpacity;
                header_menu.style.marginTop = String(header_menu_initial_marginTop + header_menu.clientHeight) + "px";

                return;
            }
            //メニュー閉じる
            function header_menu_close(){
                header_menu.style.marginTop = String(header_menu_initial_marginTop) + "px";
                header_menu.style.boxShadow = '';

                layer.style.opacity = '0';
                setTimeout(() => {
                    layer.style.display = '';
                }, 150);

                return;
            }

            //動きがあった時のイベント
            let header_gesture = new GestureDetector(true, document.getElementById("header"));
            header_gesture.addFunction((event, gesEvent) => {
                //console.info(gesEvent);

                if(gesEvent.startOfMovement){
                    //動きの始まり
                    layer.style.display = 'block';
                    header_menu.style.boxShadow = 'none';

                    header_menu.classList.remove("tra");
                    layer.classList.remove("tra");
                }

                if(gesEvent.direction == "down"){
                    let height = header_menu.clientHeight;
                    let marginTop = Math.min(Math.max(gesEvent.movement_y, 0), height);

                    //
                    header_menu.style.marginTop = String(header_menu_initial_marginTop + marginTop) + "px";
                    layer.style.opacity = String(marginTop / height * layer_defaultOpacity);
                }

                if(gesEvent.endOfMovement && gesEvent.direction == "down"){
                    //動きの終わり
                    header_menu.classList.add("tra");
                    layer.classList.add("tra");

                    //指を離した位置 or スワイプの速度 で決定
                    let judge = [(gesEvent.movement_y >= header_menu.clientHeight / 2), (gesEvent.speed.y >= .5), (gesEvent.speed.y <= -.5)];
                    if((judge[0] && !judge[2]) || judge[1]){
                        header_menu_open(gesEvent);
                    }
                    else if((!judge[0] && !judge[1]) || judge[2]){
                        header_menu_close();
                    }
                }

                return;
            });

            return;
        });

        document.addEventListener("selectionchange", () => {
            getSelection().removeAllRanges();
            return;
        });
    </script>
</body>
</html>